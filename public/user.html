<script>
  const firebaseConfig = {
    apiKey: "AIzaSyChiv7yPoDxaae7mPOqgzuEQtoGmp4KdMU",
    authDomain: "digital-queue-system-ca4a3.firebaseapp.com",
    databaseURL: "https://digital-queue-system-ca4a3-default-rtdb.firebaseio.com",
    projectId: "digital-queue-system-ca4a3",
    storageBucket: "digital-queue-system-ca4a3.appspot.com",
    messagingSenderId: "2888219915",
    appId: "1:2888219915:web:668252d6ef99882cff760e"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      const displayName = user.displayName;
      const email = user.email;
      const initials = displayName
        ? displayName.trim().split(" ").map(word => word[0]).join("").toUpperCase()
        : email[0].toUpperCase();
      document.getElementById("username").textContent = displayName || email;
      document.getElementById("avatar").textContent = initials;
    }
  });
  document.getElementById("logoutBtn").addEventListener("click", () => {
    firebase.auth().signOut().then(() => {
      alert("You have been logged out.");
      window.location.href = "login.html";
    }).catch(error => {
      alert("Logout failed: " + error.message);
    });
  });

  // Join Queue Function (QR system completely unchanged)
  function joinQueue() {
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const date = document.getElementById('appointmentDate').value;
    
    if (!name || !phone || !date) {
      alert('Please fill all fields to join the queue');
      return;
    }

    if (phone.length < 10) {
      alert('Please enter a valid phone number');
      return;
    }
    
    // Generate random queue number
    const queueNumber = Math.floor(Math.random() * 100) + 1;
    
    const ticketData = {
      name: name,
      phone: phone,
      date: date,
      position: queueNumber
    };
    
    // Update ticket display
    document.getElementById('ticketName').textContent = name;
    document.getElementById('ticketPhone').textContent = phone;
    document.getElementById('ticketDate').textContent = date;
    document.getElementById('ticketPosition').textContent = queueNumber;
    
    // Generate QR code (keeping this exactly as it was)
    const qrCodeImg = document.getElementById('qrCode');
    qrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=Patient:${name},Phone:${phone},Date:${date},Queue:${queueNumber}`;
    
    // Show ticket
    document.getElementById('ticket').style.display = 'block';
    
    // Update position message
    const waitTime = queueNumber * 5;
    document.getElementById('positionMsg').textContent = 
      `‚úÖ Successfully joined queue! You are number ${queueNumber}. Estimated wait time: ${waitTime} minutes.`;
    document.getElementById('positionMsg').style.display = 'block';

    // Hide form inputs
    document.getElementById('name').style.display = 'none';
    document.getElementById('phone').style.display = 'none';
    document.getElementById('appointmentDate').style.display = 'none';
    document.querySelector('button[onclick="joinQueue()"]').style.display = 'none';
    document.getElementById('leaveBtn').style.display = 'block';

    // Smooth scroll to ticket
    document.getElementById('ticket').scrollIntoView({ behavior: 'smooth' });
  }

  // Leave Queue Function
  function leaveQueue() {
    if (confirm('Are you sure you want to leave the queue?')) {
      document.getElementById('ticket').style.display = 'none';
      document.getElementById('positionMsg').style.display = 'none';
      
      // Show form inputs again
      document.getElementById('name').style.display = 'block';
      document.getElementById('phone').style.display = 'block';
      document.getElementById('appointmentDate').style.display = 'block';
      document.querySelector('button[onclick="joinQueue()"]').style.display = 'block';
      document.getElementById('leaveBtn').style.display = 'none';
      
      // Clear form
      document.getElementById('name').value = '';
      document.getElementById('phone').value = '';
      document.getElementById('appointmentDate').value = '';
      
      alert('You have successfully left the queue.');
    }
  }

  // Print function (keeping original functionality)
  function printTicket() {
    const printWindow = window.open('', '_blank');
    const name = document.getElementById('ticketName').textContent;
    const phone = document.getElementById('ticketPhone').textContent;
    const date = document.getElementById('ticketDate').textContent;
    const position = document.getElementById('ticketPosition').textContent;
    
    printWindow.document.write(`
      <html>
        <head>
          <title>AyurSutra Hospital Ticket</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .ticket { border: 3px solid #16a34a; border-radius: 15px; padding: 30px; max-width: 400px; margin: 0 auto; }
            .header { text-align: center; color: #16a34a; border-bottom: 2px solid #bbf7d0; padding-bottom: 15px; margin-bottom: 20px; }
            .details { margin: 15px 0; }
            .footer { margin-top: 30px; font-size: 12px; color: #15803d; text-align: center; }
          </style>
        </head>
        <body>
          <div class="ticket">
            <div class="header">
              <h1>üè• AyurSutra Healthcare</h1>
              <h2>Digital Hospital Ticket</h2>
            </div>
            <div class="details">
              <p><strong>Patient Name:</strong> ${name}</p>
              <p><strong>Phone Number:</strong> ${phone}</p>
              <p><strong>Appointment Date:</strong> ${date}</p>
              <p><strong>Queue Number:</strong> ${position}</p>
              <p><strong>Issued Time:</strong> ${new Date().toLocaleString()}</p>
            </div>
            <div class="footer">
              <p><strong>Instructions:</strong></p>
              <p>‚Ä¢ Please arrive 15 minutes before your appointment</p>
              <p>‚Ä¢ Show this ticket at the reception desk</p>
              <p>‚Ä¢ Keep your phone ready for updates</p>
              <p>‚Ä¢ Wait for your number to be called</p>
              <br>
              <p><strong>Status:</strong> VALID APPOINTMENT</p>
              <p>Thank you for choosing AyurSutra Healthcare!</p>
            </div>
          </div>
        </body>
      </html>
    `);
    
    printWindow.document.close();
    setTimeout(() => {
      printWindow.print();
      printWindow.close();
    }, 500);
  }

  // **OVERRIDE FUNCTION**: New WhatsApp function that will replace any existing ones
  function sendWhatsAppMessage() {
    console.log("Custom WhatsApp function called"); // Debug log
    
    const name = document.getElementById('ticketName').textContent;
    const phone = document.getElementById('ticketPhone').textContent;
    const date = document.getElementById('ticketDate').textContent;
    const position = document.getElementById('ticketPosition').textContent;
    
    // Current date and time in the exact format you specified
    const now = new Date();
    const bookingTime = now.toLocaleString('en-IN', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: true
    });

    // Exact WhatsApp message format as requested
    const message = `üè• *AyurSutra Hospital - Digital Queue*

üéüÔ∏è *Your Appointment Details:*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë§ *Patient:* ${name}
üìû *Phone:* ${phone}
üìÖ *Date:* ${date}
üî¢ *Queue Number:* ${position}
‚è∞ *Booked:* ${bookingTime}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìã *Instructions:*
‚Ä¢ Please arrive 15 minutes before your appointment
‚Ä¢ Show this message at the reception desk
‚Ä¢ Keep your phone ready for queue updates
‚Ä¢ Wait for your number to be called

üè• *Hospital:* AyurSutra Healthcare
üìç *Location:* [Your Hospital Address]
‚òéÔ∏è *Contact:* [Hospital Phone Number]

‚úÖ *Status:* CONFIRMED APPOINTMENT
üåø Thank you for choosing AyurSutra Healthcare!

_This is an automated message from AyurSutra Digital Queue System_`;

    const encodedMessage = encodeURIComponent(message);
    const whatsappURL = `https://wa.me/?text=${encodedMessage}`;
    
    console.log("Opening WhatsApp with message:", message); // Debug log
    window.open(whatsappURL, '_blank');
  }

  // **CRITICAL**: Override any existing WhatsApp functions after DOM loads
  document.addEventListener('DOMContentLoaded', function() {
    // Force override any existing WhatsApp functions
    window.sendWhatsAppMessage = sendWhatsAppMessage;
    
    // Also check if there's a WhatsApp button and update its onclick
    const waBtn = document.getElementById('waBtn');
    if (waBtn) {
      waBtn.onclick = function(e) {
        e.preventDefault();
        sendWhatsAppMessage();
        return false;
      };
      // Also update href to prevent default behavior
      waBtn.href = "javascript:void(0)";
    }
    
    console.log("WhatsApp function override complete");
  });

  // **BACKUP**: Override after external scripts load
  window.addEventListener('load', function() {
    setTimeout(() => {
      window.sendWhatsAppMessage = sendWhatsAppMessage;
      console.log("WhatsApp function override applied after page load");
    }, 1000);
  });
</script>

<!-- IMPORTANT: Load external scripts AFTER our custom functions -->
<script>
  // Override any functions from external scripts
  document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for external scripts to load, then override
    setTimeout(() => {
      if (window.sendWhatsAppMessage) {
        console.log("Overriding existing WhatsApp function");
      }
      
      // Force our function to be the active one
      window.sendWhatsAppMessage = function() {
        console.log("Custom WhatsApp function called"); 
        
        const name = document.getElementById('ticketName').textContent;
        const phone = document.getElementById('ticketPhone').textContent;
        const date = document.getElementById('ticketDate').textContent;
        const position = document.getElementById('ticketPosition').textContent;
        
        const now = new Date();
        const bookingTime = now.toLocaleString('en-IN', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: true
        });

        const message = `üè• *AyurSutra Hospital - Digital Queue*

üéüÔ∏è *Your Appointment Details:*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë§ *Patient:* ${name}
üìû *Phone:* ${phone}
üìÖ *Date:* ${date}
üî¢ *Queue Number:* ${position}
‚è∞ *Booked:* ${bookingTime}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìã *Instructions:*
‚Ä¢ Please arrive 15 minutes before your appointment
‚Ä¢ Show this message at the reception desk
‚Ä¢ Keep your phone ready for queue updates
‚Ä¢ Wait for your number to be called

üè• *Hospital:* AyurSutra Healthcare
üìç *Location:* [Your Hospital Address]
‚òéÔ∏è *Contact:* [Hospital Phone Number]

‚úÖ *Status:* CONFIRMED APPOINTMENT
üåø Thank you for choosing AyurSutra Healthcare!

_This is an automated message from AyurSutra Digital Queue System_`;

        const encodedMessage = encodeURIComponent(message);
        const whatsappURL = `https://wa.me/?text=${encodedMessage}`;
        
        window.open(whatsappURL, '_blank');
      };
      
    }, 2000); // Wait 2 seconds for external scripts
  });
</script>

<!-- Custom JS - Load these AFTER our overrides -->
<script src="userAdmin.js"></script>
<script src="service.js"></script>
